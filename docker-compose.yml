# docker-compose �̃o�[�W����
version: '3.4'

# �e�R���e�i�̏��
services:

# osake �A�v���P�[�V�����p

  # postgres �T�[�r�X
  postgres:
    # �R���e�i�̖��O
    container_name: postgres-container
    depends_on:
      - fluentd
    # Dockerfile �̃f�B���N�g���p�X
    build:
      context: .
      dockerfile: ./docker/postgres/Dockerfile
    # ���O���W�p�ݒ�
    logging:
      # ���M���O�h���C�o�� fluentd ��
      driver: "fluentd"
      options:
        # fluentd �̃A�h���X�E���J�|�[�g��w��
        fluentd-address: "192.168.99.100:24224"

  # golang �A�v���P�[�V����
  # �J�����p
  osake-dev:
    container_name: osake-dev-container
    # postgres �̃R���e�i�ƃ����N
    depends_on:
      - postgres
    # Dockerfile ��w��
    build:
      context: .
      dockerfile: ./docker/golang/Dockerfile
      target: build_env
    # ${GOPATH}/src ��}�E���g
    volumes:
      - ./go:/go/src/github.com/muroya2355/osake/go/
    # docker-compose run ���s���Ɏ��s�����R�}���h
    command: bash -c "go build -o osake && ./osake"

  # golang �A�v���P�[�V����
  # ���s���p
  osake:
    container_name: osake-run-container
    depends_on:
      - postgres
      - fluentd
    build:
      context: .
      dockerfile: ./docker/golang/Dockerfile
    command: sh -c "cd /usr/local/osake && ./osake"
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "192.168.99.100:24224"

  # httpd �T�[�r�X
  httpd:
    container_name: httpd-container
    depends_on:
      - postgres
      - osake
      - fluentd
    build:
      context: .
      dockerfile: ./docker/httpd/Dockerfile
    ports:
      - "443:443"
    volumes:
      # �ݒ�t�@�C�� (���o�[�X�v���L�V�ݒ�̂���)
      - ./docker/httpd/conf/httpd.conf:/usr/local/apache2/conf/httpd.conf
      - ./docker/httpd/conf/extra/httpd-vhosts.conf:/usr/local/apache2/conf/extra/httpd-vhosts.conf
      - ./docker/httpd/conf/extra/httpd-ssl.conf:/usr/local/apache2/conf/extra/httpd-ssl.conf
      - ./docker/httpd/conf/server.crt:/usr/local/apache2/conf/server.crt # �t�@�C���͊e���ŗp��
      - ./docker/httpd/conf/server.key:/usr/local/apache2/conf/server.key # �t�@�C���͊e���ŗp��
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "192.168.99.100:24224"

  # nginx �T�[�r�X
  nginx:
    container_name: nginx-container
    depends_on:
      - kibana
    build:
      context: .
      dockerfile: ./docker/nginx/Dockerfile
    ports:
      - "80:80"
    volumes:
      - ./docker/nginx/conf.d/default.conf:/etc/nginx/conf.d/default.conf
      - ./docker/nginx/htpasswd:/etc/nginx/.htpasswd # �t�@�C���͊e���ŗp��

# ���O���W�p

  elasticsearch:
    container_name: elasticsearch-container
    image: elasticsearch:5.6-alpine
    ports:
      - "9200:9200"
    volumes:
      - ./docker/elasticsearch/jvm.options:/usr/share/elasticsearch/config/jvm.options
  
  kibana:
    container_name: kibana-container
    image: kibana:5.6
    environment:
      ELASTICSEARCH_URL: "http://elasticsearch:9200"
    depends_on:
      - elasticsearch

  fluentd:
    container_name: fluentd-container
    build:
     context: .
     dockerfile: ./docker/fluentd/Dockerfile
    ports:
      - "24224:24224"
      - "24220:24220"
      - "24224:24224/udp"
    depends_on:
      - elasticsearch
